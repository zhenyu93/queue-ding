<!doctype html>
<meta charset="utf-8">
<title>Now Serving — Ding Player</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
  :root{
    --bg:#0b1220; --card:#121a2b; --fg:#ecf2ff; --muted:#9fb3c8; --accent:#71c7ec;
  }
  html,body{height:100%; margin:0; background:var(--bg); color:var(--fg);
    font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
  .wrap{ height:100%; display:flex; align-items:center; justify-content:center; }
  .board{ width:100%; height:100%; display:grid; grid-template-columns: 4fr 1fr; gap:20px; padding:30px; box-sizing:border-box;}
  .current{
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    border-radius:20px; background:var(--card); box-shadow:0 20px 60px rgba(0,0,0,.35);
  }
  .ticket{
    font-size:12vw; /* scales with screen width */
    font-weight:900; letter-spacing:2px; line-height:1; text-align:center;
    word-break:break-word;
  }
  .counter{
    font-size:5vw; font-weight:700; margin-top:2.5rem; color:var(--muted);
  }
  .previous{
    border-radius:20px; background:var(--card); padding:20px; overflow-y:auto;
    box-shadow:0 20px 60px rgba(0,0,0,.35);
  }
  .label{ font-size:14px; text-transform:uppercase; color:var(--muted); margin-bottom:10px; }
  .prev-item{
    display:flex; justify-content:space-between; align-items:center;
    padding:10px 12px; margin-bottom:8px; border-radius:12px;
    background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06);
  }
  .prev-left{ display:flex; flex-direction:column; }
  .prev-ticket{ font-weight:1000; font-size:40px; }
  .prev-sub{ font-size:18px; color:var(--muted); }
  .blink{ animation:blink 1s ease-out 3 }
  @keyframes blink{
    0%{ transform:scale(1); box-shadow:0 0 0 rgba(113,199,236,.6) }
    50%{ transform:scale(1.02); box-shadow:0 0 30px rgba(113,199,236,.45) }
    100%{ transform:scale(1); box-shadow:0 0 0 rgba(113,199,236,0) }
  }
  /* Overlay for autoplay unlock */
  .overlay{
    position:fixed; inset:0; background:rgba(0,0,0,.55);
    display:none; align-items:center; justify-content:center;
  }
  .overlay .panel{
    background:var(--card); padding:20px 24px; border-radius:16px; text-align:center;
    max-width:440px; box-shadow:0 10px 30px rgba(0,0,0,.4);
  }
  .overlay button{
    margin-top:12px; background:var(--accent); color:#071019; border:0;
    border-radius:10px; padding:10px 16px; font-weight:800; cursor:pointer;
  }
</style>

<div class="wrap">
  <div class="board">
    <!-- Current call -->
    <div class="current" id="currentCard">
      <div class="ticket" id="ticket">—</div>
      <div class="counter" id="counter">Counter —</div>
    </div>

    <!-- Previous calls -->
    <div class="previous">
      <div class="label">Recently Called</div>
      <div id="prevList"></div>
    </div>
  </div>
</div>

<!-- Sound -->
<audio id="ding" preload="auto"
  src="https://zhenyu93.github.io/queue-ding/mixkit-airport-announcement-ding-1569.mp3"></audio>

<!-- Autoplay unlock overlay -->
<div class="overlay" id="overlay">
  <div class="panel">
    <div style="font-weight:800; font-size:18px; margin-bottom:6px;">Enable Sound</div>
    <div class="muted">Click once to allow audio for this page.</div>
    <button id="overlayBtn">Enable sound</button>
  </div>
</div>

<script>
  /************* CONFIG *************/
  const AIRTABLE_TOKEN     = "paty7dc6oUwE3AcK4.b0926f7e850d8f371e5cc711af0fcfa42cab943e0c8b05b380ef54e8c53e723c"; // read-only PAT
  const BASE_ID            = "appY6mqMYKWdUQEKS";
  const TABLE_NAME         = "Ticket Queue";
  const VIEW_NAME          = "";
  const FIELD_STATUS       = "Status";
  const FIELD_TICKET       = "Staff Name";
  const FIELD_TIME_CALLED  = "Time Called";
  const FIELD_COUNTER_OPT  = "Counter";
  const POLL_MS            = 1000;

  /************* RUNTIME *************/
  const $ = (id)=>document.getElementById(id);
  const elTicket=$("ticket"), elCounter=$("counter");
  const elPrevList=$("prevList"), elCurrentCard=$("currentCard");
  const audio=$("ding"), overlay=$("overlay"), overlayBtn=$("overlayBtn");

  let soundOK=false, lastKey=null;

  // Try autoplay immediately
  (async()=>{
    try{ await audio.play(); audio.pause(); audio.currentTime=0; soundOK=true; }
    catch{ overlay.style.display="flex"; }
  })();
  overlayBtn.onclick=async()=>{
    try{ await audio.play(); audio.pause(); audio.currentTime=0; soundOK=true; overlay.style.display="none"; }
    catch{}
  };

  function keyFor(rec){ return rec.id+"::"+(rec.fields?.[FIELD_TIME_CALLED]||""); }
  const get=(rec,f)=>f?(rec.fields?.[f]??""):"";

  async function fetchTopN(n){
    const url=new URL(`https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(TABLE_NAME)}`);
    if(VIEW_NAME) url.searchParams.set("view",VIEW_NAME);
    url.searchParams.set("maxRecords",String(n));
    url.searchParams.set("filterByFormula",`AND({${FIELD_STATUS}}='Called')`);
    url.searchParams.set("sort[0][field]",FIELD_TIME_CALLED);
    url.searchParams.set("sort[0][direction]","desc");
    const res=await fetch(url,{headers:{Authorization:`Bearer ${AIRTABLE_TOKEN}`},cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const data=await res.json(); return data.records||[];
  }

  function renderPrevious(list){
    elPrevList.innerHTML="";
    if(!list.length){ elPrevList.innerHTML='<div class="muted">—</div>'; return; }
    for(const rec of list){
      const t=rec.fields?.[FIELD_TICKET]??"—";
      const c=get(rec,FIELD_COUNTER_OPT);
      const ts=rec.fields?.[FIELD_TIME_CALLED]?new Date(rec.fields[FIELD_TIME_CALLED]):null;
      const sub=(ts?ts.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}):"—")+(c?` • Counter ${c}`:"");
      const div=document.createElement("div");
      div.className="prev-item";
      div.innerHTML=`<div class="prev-left"><div class="prev-ticket">${t}</div><div class="prev-sub">${sub}</div></div>`;
      elPrevList.appendChild(div);
    }
  }

   async function tick(){
    try{
      const recs = await fetchTopN(6);
      const current = recs[0], previous = recs.slice(1, 6);

      if (current){
        const ticket  = current.fields?.[FIELD_TICKET] ?? "—";
        const counter = get(current, FIELD_COUNTER_OPT);

        elTicket.textContent = ticket;

        // Counter text + colour mapping
        if (counter){
          elCounter.textContent = `COUNTER ${counter}`;
          if (String(counter) === "1")      elCounter.style.color = "#1890ff"; // blue
          else if (String(counter) === "2") elCounter.style.color = "#52c41a"; // green
          else if (String(counter) === "3") elCounter.style.color = "#fa8c16"; // orange
          else                              elCounter.style.color = "var(--muted)"; // fallback
        } else {
          elCounter.textContent = "";
          elCounter.style.color = "var(--muted)";
        }

        const key = keyFor(current);
        if (lastKey === null){
          lastKey = key; // first load: baseline (no ding)
        } else if (key !== lastKey){
          lastKey = key;
          if (soundOK){ audio.currentTime = 0; audio.play().catch(()=>{}); }
          elCurrentCard.classList.remove("blink"); void elCurrentCard.offsetWidth; elCurrentCard.classList.add("blink");
        }
      } else {
        elTicket.textContent = "—";
        elCounter.textContent = "";
        elCounter.style.color = "var(--muted)";
        lastKey = null;
      }

      renderPrevious(previous);
    } catch(e){
      console.error(e);
    } finally {
      setTimeout(tick, POLL_MS);
    }
  }
  tick();
</script>
